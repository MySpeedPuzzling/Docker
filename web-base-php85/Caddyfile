{
    # Disable automatic HTTPS (we're behind a reverse proxy)
    auto_https off

    # Global Caddy runtime logs (startup, errors, internal events)
    log {
        output stdout
        format console
    }

    # Server configuration
    servers {
        # Allow large request headers (128KB)
        max_header_size 128kb

        # Enable full-duplex for HTTP/1.1 connections
        # Required for SSE, streaming responses, Mercure, etc.
        enable_full_duplex
    }

    # FrankenPHP worker configuration (injected via FRANKENPHP_CONFIG env var)
    # Example: FRANKENPHP_CONFIG="worker { file /app/public/index.php num 4 }"
    frankenphp {
        {$FRANKENPHP_CONFIG}
    }

    # Additional global options can be injected via CADDY_GLOBAL_OPTIONS
    {$CADDY_GLOBAL_OPTIONS}
}

# Import user-provided Caddyfile snippets (optional)
import /etc/frankenphp/Caddyfile.d/*.caddyfile

:8080 {
    root * /app/public

    # Encode responses with zstd/gzip
    encode zstd gzip

    # Mercure hub (real-time messaging)
    # Set MERCURE_PUBLISHER_JWT_KEY and MERCURE_SUBSCRIBER_JWT_KEY to enable
    mercure {
        publisher_jwt {$MERCURE_PUBLISHER_JWT_KEY}
        subscriber_jwt {$MERCURE_SUBSCRIBER_JWT_KEY}
    }

    # PHP handling
    # In non-worker mode: serves static files, falls back to PHP
    # In worker mode: worker config is applied globally via frankenphp block
    php_server
}
