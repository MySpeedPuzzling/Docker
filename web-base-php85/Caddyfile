{
    # Disable automatic HTTPS (we're behind a reverse proxy)
    auto_https off

    # Global Caddy runtime logs (startup, errors, internal events)
    log {
        output stdout
        format console
    }

    # Server configuration
    servers {
        # Trust private IP ranges for X-Forwarded-* headers (Traefik, etc.)
        # Required for proper HTTPS detection behind reverse proxies
        trusted_proxies static private_ranges

        # Allow large request headers (128KB)
        max_header_size 128kb

        # Enable full-duplex for HTTP/1.1 connections
        # Required for SSE, streaming responses, etc.
        enable_full_duplex
    }

    # FrankenPHP worker configuration (injected via FRANKENPHP_CONFIG env var)
    # Example: FRANKENPHP_CONFIG="worker { file /app/public/index.php num 4 }"
    frankenphp {
        {$FRANKENPHP_CONFIG}
    }

    # Additional global options can be injected via CADDY_GLOBAL_OPTIONS
    {$CADDY_GLOBAL_OPTIONS}
}

# Import user-provided Caddyfile snippets (optional)
import /etc/frankenphp/Caddyfile.d/*.caddyfile

:8080 {
    root * /app/public

    # Immutable cache for content-hashed build assets (Webpack Encore)
    @buildAssets path /build/*
    header @buildAssets Cache-Control "public, max-age=31536000, immutable"

    # Long cache for static assets that rarely change
    @staticAssets path /img/* /fonts/*
    header @staticAssets Cache-Control "public, max-age=2592000"

    # Encode responses with brotli/gzip (brotli preferred, ~20% smaller than gzip)
    encode br gzip

    # PHP handling
    # In non-worker mode: serves static files, falls back to PHP
    # In worker mode: worker config is applied globally via frankenphp block
    php_server
}
